#!/usr/bin/env bash
set -euo pipefail

# fetch â€” fetch all gems from .gemset files into cache/
#
# Reads .gemset files (one "name version [git:uri@rev]" per line),
# dedupes, and fetches each gem in parallel via bin/fetch-gem.
#
# Usage:
#   fetch                          # all imports/*.gemset
#   fetch imports/fizzy.gemset     # single file
#   fetch imports/                 # all files in directory
#   cat imports/*.gemset | fetch - # from stdin

dir="$(cd "$(dirname "$0")" && pwd)"
root="$(cd "$dir/.." && pwd)"
fetch_gem="$dir/fetch-gem"
jobs="${JOBS:-20}"

# Resolve input to a stream of lines
if [ $# -eq 0 ]; then
  input="$root/imports"
fi
input="${input:-${1}}"

if [ "$input" = "-" ]; then
  # Read from stdin
  lines=$(cat)
elif [ -d "$input" ]; then
  lines=$(cat "$input"/*.gemset 2>/dev/null)
elif [ -f "$input" ]; then
  lines=$(cat "$input")
else
  echo "Usage: fetch [imports/ | file.gemset | -]" >&2
  exit 1
fi

# Dedupe: sort by name+version, keep unique
sorted=$(echo "$lines" | grep -v '^\s*#' | grep -v '^\s*$' | sort -u -k1,2)
total=$(echo "$sorted" | wc -l)

echo "$total unique gems to fetch (jobs=$jobs)" >&2

# Feed into parallel fetch-gem
echo "$sorted" | xargs -P "$jobs" -I {} "$fetch_gem" "{}" 2>&1 | \
  awk -v total="$total" '
    /^FAIL:/ { fails++; print > "/dev/stderr"; next }
    { done++; if (done % 50 == 0 || done == total) printf "\r  %d/%d fetched", done, total > "/dev/stderr" }
    END {
      printf "\r  %d/%d fetched", done, total > "/dev/stderr"
      if (fails > 0) printf " (%d failed)", fails > "/dev/stderr"
      print "" > "/dev/stderr"
    }
  '
