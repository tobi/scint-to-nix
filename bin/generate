#!/usr/bin/env ruby
# frozen_string_literal: true

# generate — build per-gem Nix derivations from fetched gem cache
#
# Each gem: nix/<name>/<version>/default.nix
# If overlays/<name>.nix exists, it's imported for extra nativeBuildInputs
# and optional buildPhase override.
#
# Usage:
#   generate              — generate from all cached gems
#   generate -o nix/      — custom output dir

require "json"
require "fileutils"

CACHE_DIR    = File.join(__dir__, "..", "cache")
SOURCE_DIR   = File.join(CACHE_DIR, "sources")
META_DIR     = File.join(CACHE_DIR, "meta")
OVERLAYS_DIR = File.join(__dir__, "..", "overlays")

output_dir = File.join(__dir__, "..", "nix")

i = 0
while i < ARGV.length
  case ARGV[i]
  when "-o", "--output" then output_dir = ARGV[i += 1]
  when "-h", "--help"
    $stderr.puts "Usage: generate [-o nix/]"
    exit 0
  else abort "Unknown option: #{ARGV[i]}"
  end
  i += 1
end

output_dir = File.expand_path(output_dir)
FileUtils.mkdir_p(output_dir)

# Which gems have overlays?
overlays = {}
if Dir.exist?(OVERLAYS_DIR)
  Dir.glob(File.join(OVERLAYS_DIR, "*.nix")).each do |f|
    overlays[File.basename(f, ".nix")] = true
  end
end

# -- Load all metadata -----------------------------------------------------

meta_by_key = {}
Dir.glob(File.join(META_DIR, "*.json")).each do |f|
  m = JSON.parse(File.read(f), symbolize_names: true)
  meta_by_key["#{m[:name]}-#{m[:version]}"] = m
end

$stderr.puts "#{meta_by_key.size} gems in cache (#{overlays.size} overlays)"

# -- Per-gem derivations ---------------------------------------------------

generated = 0

meta_by_key.each_value do |meta|
  name    = meta[:name]
  version = meta[:version]
  key     = "#{name}-#{version}"

  source_dir = File.join(SOURCE_DIR, key)
  next unless Dir.exist?(source_dir)

  has_ext       = meta[:has_extensions] || !Dir.glob(File.join(source_dir, "ext", "**", "extconf.rb")).empty?
  require_paths = meta[:require_paths] || ["lib"]
  executables   = meta[:executables] || []
  bindir        = meta[:bindir] || "exe"

  # Verify require_paths exist
  verified = require_paths.select { |p| Dir.exist?(File.join(source_dir, p)) }
  require_paths = verified unless verified.empty?

  gem_dir = File.join(output_dir, name, version)
  FileUtils.mkdir_p(gem_dir)
  FileUtils.ln_sf(source_dir, File.join(gem_dir, "source"))

  has_overlay = overlays.key?(name)

  nix = +""
  nix << "# #{name} #{version}\n"

  if has_overlay
    nix << "{ lib, stdenv, ruby, pkgs }:\n\n"
    nix << "let\n"
    nix << "  rubyVersion = \"${ruby.version.majMin}.0\";\n"
    nix << "  arch = stdenv.hostPlatform.system;\n"
    nix << "  prefix = \"ruby/${rubyVersion}\";\n"
    nix << "  overlay = import ../../../overlays/#{name}.nix { inherit pkgs ruby; };\n"
    nix << "  overlayDeps = if builtins.isList overlay then overlay else overlay.deps or [];\n"
    nix << "  overlayBuildPhase = if builtins.isAttrs overlay && overlay ? buildPhase then overlay.buildPhase else null;\n"
    nix << "in\n\n"
  else
    nix << "{ lib, stdenv, ruby }:\n\n"
    nix << "let\n"
    nix << "  rubyVersion = \"${ruby.version.majMin}.0\";\n"
    nix << "  arch = stdenv.hostPlatform.system;\n"
    nix << "  prefix = \"ruby/${rubyVersion}\";\n"
    nix << "in\n\n"
  end

  nix << "stdenv.mkDerivation {\n"
  nix << "  pname = \"#{name}\";\n"
  nix << "  version = \"#{version}\";\n"
  nix << "  src = builtins.path { path = ./source; name = \"#{key}-source\"; };\n\n"

  if has_ext
    if has_overlay
      nix << "  nativeBuildInputs = [ ruby ] ++ overlayDeps;\n\n"
      nix << "  buildPhase = if overlayBuildPhase != null then overlayBuildPhase else ''\n"
    else
      nix << "  nativeBuildInputs = [ ruby ];\n\n"
      nix << "  buildPhase = ''\n"
    end
    nix << "    for extconf in $(find ext -name extconf.rb 2>/dev/null); do\n"
    nix << "      dir=$(dirname \"$extconf\")\n"
    nix << "      echo \"Building extension in $dir\"\n"
    nix << "      (cd \"$dir\" && ruby extconf.rb && make -j$NIX_BUILD_CORES)\n"
    nix << "    done\n"
    nix << "    for makefile in $(find ext -name Makefile 2>/dev/null); do\n"
    nix << "      dir=$(dirname \"$makefile\")\n"
    nix << "      target_name=$(sed -n 's/^TARGET = //p' \"$makefile\")\n"
    nix << "      target_prefix=$(sed -n 's/^target_prefix = //p' \"$makefile\")\n"
    nix << "      if [ -n \"$target_name\" ] && [ -f \"$dir/$target_name.so\" ]; then\n"
    nix << "        mkdir -p \"lib$target_prefix\"\n"
    nix << "        cp \"$dir/$target_name.so\" \"lib$target_prefix/$target_name.so\"\n"
    nix << "        echo \"Installed $dir/$target_name.so -> lib$target_prefix/$target_name.so\"\n"
    nix << "      fi\n"
    nix << "    done\n"
    nix << "  '';\n\n"
  else
    nix << "  dontBuild = true;\n"
  end

  nix << "  dontConfigure = true;\n\n"

  nix << "  passthru = { inherit prefix; };\n\n"
  nix << "  installPhase = ''\n"
  nix << "    local dest=$out/${prefix}\n"
  nix << "    mkdir -p $dest/gems/#{key}\n"
  nix << "    cp -r . $dest/gems/#{key}/\n"

  if has_ext
    nix << "    # Install compiled extensions\n"
    nix << "    local extdir=$dest/extensions/${arch}/${rubyVersion}/#{key}\n"
    nix << "    mkdir -p $extdir\n"
    nix << "    find . -name '*.so' -path '*/lib/*' | while read so; do\n"
    nix << "      cp \"$so\" \"$extdir/\"\n"
    nix << "    done\n"
  end

  nix << "    mkdir -p $dest/specifications\n"
  nix << "    cat > $dest/specifications/#{key}.gemspec <<'EOF'\n"
  nix << "Gem::Specification.new do |s|\n"
  nix << "  s.name = \"#{name}\"\n"
  nix << "  s.version = \"#{version}\"\n"
  nix << "  s.summary = \"#{name}\"\n"
  nix << "  s.require_paths = [#{require_paths.map { |p| "\"#{p}\"" }.join(", ")}]\n"
  unless executables.empty?
    nix << "  s.bindir = \"#{bindir}\"\n"
    nix << "  s.executables = [#{executables.map { |e| "\"#{e}\"" }.join(", ")}]\n"
  end
  nix << "  s.files = []\n"
  nix << "end\n"
  nix << "EOF\n"

  unless executables.empty?
    nix << "    mkdir -p $dest/bin\n"
    executables.each do |exe|
      nix << "    cat > $dest/bin/#{exe} <<'BINSTUB'\n"
      nix << "#!/usr/bin/env ruby\n"
      nix << "require \"rubygems\"\n"
      nix << "load Gem.bin_path(\"#{name}\", \"#{exe}\", \"#{version}\")\n"
      nix << "BINSTUB\n"
      nix << "    chmod +x $dest/bin/#{exe}\n"
    end
  end

  nix << "  '';\n"
  nix << "}\n"

  File.write(File.join(gem_dir, "default.nix"), nix)
  generated += 1
end

$stderr.puts "#{generated} derivations"
