#!/usr/bin/env bash
# Run all lint checks.

set -euo pipefail

dir="$(cd "$(dirname "$0")" && pwd)"
project="${1:-fizzy}"

checks=(
  symlinks
  nix-eval
  nixfmt
  statix
  dep-completeness
  source-clean
  secrets
  require-paths-vs-gem-metadata
  gemspec-deps
  require-paths
  native-extensions
  loadable
)

total=${#checks[@]}
passed=0
failed=0
skipped=0
failures=()
timings=()

now() { date +%s%3N; }

fmt_ms() {
  local ms=$1
  if (( ms < 1000 )); then
    printf "%dms" "$ms"
  else
    printf "%d.%ds" "$((ms / 1000))" "$((ms % 1000 / 100))"
  fi
}

i=0
for check in "${checks[@]}"; do
  i=$((i + 1))
  script="$dir/$check"
  printf "\033[1m[%d/%d] %s\033[0m " "$i" "$total" "$check"

  t0=$(now)
  if output=$("$script" "$project" 2>&1); then
    t1=$(now)
    elapsed=$((t1 - t0))
    printf "\033[32m✓\033[0m %s\n" "$(fmt_ms $elapsed)"
    passed=$((passed + 1))
  else
    code=$?
    t1=$(now)
    elapsed=$((t1 - t0))
    if [ "$code" -eq 2 ]; then
      printf "\033[33m⊘ skipped\033[0m %s\n" "$(fmt_ms $elapsed)"
      skipped=$((skipped + 1))
    else
      printf "\033[31m✗ FAIL\033[0m %s\n" "$(fmt_ms $elapsed)"
      failed=$((failed + 1))
      failures+=("$check")
    fi
  fi
  timings+=("$(fmt_ms $elapsed)")

  # Show last line of output as detail (if any)
  last=$(echo "$output" | tail -1)
  if [ -n "$last" ]; then
    printf "  %s\n" "$last"
  fi
done

echo ""
echo "================================"
printf "%d passed, %d failed, %d skipped (of %d)\n" "$passed" "$failed" "$skipped" "$total"
if [ "$failed" -gt 0 ]; then
  echo "Failures: ${failures[*]}"
  exit 1
fi
