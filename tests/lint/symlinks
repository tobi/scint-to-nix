#!/usr/bin/env bash
# Lint: source symlinks in nix/gem/ are clean; no self-referencing dirs in cache/sources/.
set -euo pipefail

root="$(cd "$(dirname "$0")/../.." && pwd)"
bad=0

# --- nix/gem source symlinks: clean absolute, no ../, resolvable ---
total=$(find "$root/nix" -type l | wc -l)

unclean=$(find "$root/nix" -type l -printf '%l\n' | grep -c '\.\.' || true)
if [ "$unclean" -gt 0 ]; then
  echo "FAIL: $unclean symlinks contain ../"
  find "$root/nix" -type l -printf '%p â†’ %l\n' | grep '\.\.' | head -5
  bad=$((bad + unclean))
fi

broken=$(find "$root/nix" -type l -print0 | xargs -0 realpath 2>&1 | grep -c 'No such file' || true)
if [ "$broken" -gt 0 ]; then
  echo "FAIL: $broken broken symlinks in nix/"
  bad=$((bad + broken))
fi

# --- cache/sources: no self-referencing dirs (name-ver/name-ver) ---
selfrefs=0
while IFS= read -r d; do
  [[ "$(basename "$(dirname "$d")")" == "$(basename "$d")" ]] && selfrefs=$((selfrefs + 1))
done < <(find "$root/cache/sources" -maxdepth 2 -mindepth 2 -type d 2>/dev/null)
if [ "$selfrefs" -gt 0 ]; then
  echo "FAIL: $selfrefs self-referencing dirs in cache/sources/"
  find "$root/cache/sources" -maxdepth 2 -mindepth 2 -type d 2>/dev/null | while read -r d; do
    [[ "$(basename "$(dirname "$d")")" == "$(basename "$d")" ]] && echo "  $d"
  done | head -5
  bad=$((bad + selfrefs))
fi

if [ "$bad" -gt 0 ]; then
  echo "$bad problem(s)"
  exit 1
else
  echo "OK: $total source symlinks clean, 0 self-referencing dirs"
fi
