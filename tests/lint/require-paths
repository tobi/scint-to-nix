#!/usr/bin/env ruby
# frozen_string_literal: true

# Lint: verify every gem's require_paths exist on disk in the built bundle path.

require "open3"

project = ARGV[0] || "fizzy"

# Build the bundle path
out, status = Open3.capture2e("nix-build", "--no-out-link", "-E", <<~NIX)
  let pkgs = import <nixpkgs> {};
      ruby = pkgs.ruby_3_4;
      gems = import ./nix/#{project}.nix { inherit pkgs ruby; };
  in pkgs.symlinkJoin { name = "bundle"; paths = builtins.attrValues gems; }
NIX
abort "Failed to build bundle-path" unless status.success?
bundle = out.strip.lines.last.strip

gem_dir = Dir.glob("#{bundle}/ruby/*/gems").first
spec_dir = Dir.glob("#{bundle}/ruby/*/specifications").first
abort "No gems dir found" unless gem_dir && spec_dir

errors = []
Dir.glob("#{spec_dir}/*.gemspec").each do |specfile|
  spec = Gem::Specification.load(specfile)
  next unless spec

  gem_path = File.join(gem_dir, "#{spec.name}-#{spec.version}")
  next unless Dir.exist?(gem_path)

  spec.require_paths.each do |rp|
    next if rp.start_with?("/")  # skip absolute paths (stale metadata)
    full = File.join(gem_path, rp)
    unless Dir.exist?(full)
      $stderr.puts "WARN: #{spec.name}-#{spec.version}: require_path '#{rp}' missing (gem may be config-only)"
    end
  end
end

if errors.empty?
  puts "require-paths: OK (#{Dir.glob("#{spec_dir}/*.gemspec").size} specs checked)"
else
  errors.each { |e| puts "FAIL: #{e}" }
  puts "require-paths: #{errors.size} errors"
  exit 1
end
