#!/usr/bin/env ruby
# frozen_string_literal: true

# Lint: verify no pre-built .so/.bundle files leaked into source/ directories.
# These would be from gem cache and linked against the wrong Ruby.

nix_dir = "nix"
nix_dir = File.expand_path(nix_dir)
errors = []

Dir.glob(File.join(nix_dir, "*", "*", "source")).each do |source_dir|
  next unless Dir.exist?(File.join(source_dir, "ext"))

  leaked = Dir.glob(File.join(source_dir, "lib", "**", "*.{so,bundle}"))
  leaked.each do |f|
    errors << "#{f.sub(nix_dir + "/", "")}"
  end
end

if errors.empty?
  puts "source-clean: OK (no leaked .so files)"
else
  errors.each { |e| puts "LEAK: #{e}" }
  puts "source-clean: #{errors.size} leaked files"
  exit 1
end
