#!/usr/bin/env bash
# Lint: verify all nix files parse without errors.

set -euo pipefail

nix_dir="nix"
errors=0
checked=0

# Per-gem derivations
for f in "$nix_dir"/*/default.nix "$nix_dir"/*/*/default.nix "$nix_dir"/git/*/default.nix; do
  [ -f "$f" ] || continue
  if ! nix-instantiate --parse "$f" > /dev/null 2>&1; then
    echo "FAIL: $f does not parse"
    nix-instantiate --parse "$f" 2>&1 | head -5
    errors=$((errors + 1))
  fi
  checked=$((checked + 1))
done

# Project gemset files
for f in "$nix_dir"/*.nix; do
  [ -f "$f" ] || continue
  if ! nix-instantiate --parse "$f" > /dev/null 2>&1; then
    echo "FAIL: $f does not parse"
    nix-instantiate --parse "$f" 2>&1 | head -5
    errors=$((errors + 1))
  fi
  checked=$((checked + 1))
done

# Overlay files
for f in overlays/*.nix; do
  [ -f "$f" ] || continue
  if ! nix-instantiate --parse "$f" > /dev/null 2>&1; then
    echo "FAIL: $f does not parse"
    nix-instantiate --parse "$f" 2>&1 | head -5
    errors=$((errors + 1))
  fi
  checked=$((checked + 1))
done

echo "nix-eval: $checked checked, $errors errors"
[ "$errors" -eq 0 ]
