#!/usr/bin/env ruby
# frozen_string_literal: true

# Lint: compare generated require_paths against gem metadata in cache.

require "json"

nix_dir  = "nix"
meta_dir = "cache/meta"
errors = []
checked = 0

Dir.glob(File.join(meta_dir, "*.json")).each do |f|
  meta = JSON.parse(File.read(f))
  name = meta["name"]
  version = meta["version"]
  meta_paths = (meta["require_paths"] || ["lib"]).reject { |p| p.start_with?("/") }

  specfile = File.join(nix_dir, name, version, "default.nix")
  next unless File.exist?(specfile)

  nix_content = File.read(specfile)
  # Extract require_paths from the generated gemspec
  if nix_content =~ /s\.require_paths\s*=\s*\[([^\]]+)\]/
    nix_paths = $1.scan(/"([^"]+)"/).flatten.reject { |p| p.start_with?("/") }.sort
    meta_sorted = meta_paths.sort
    if nix_paths != meta_sorted
      errors << "#{name}-#{version}: nix=#{nix_paths} vs meta=#{meta_sorted}"
    end
  end
  checked += 1
end

if errors.empty?
  puts "require-paths-vs-meta: OK (#{checked} checked)"
else
  errors.each { |e| puts "MISMATCH: #{e}" }
  puts "require-paths-vs-meta: #{errors.size} mismatches out of #{checked}"
  exit 1
end
