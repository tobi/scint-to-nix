#!/usr/bin/env bash
# Check all .nix files pass nixfmt --check
set -euo pipefail
dir="$(cd "$(dirname "$0")" && pwd)"
root="$(cd "$dir/../.." && pwd)"

files=$(find "$root/nix" "$root/overlays" -name '*.nix' 2>/dev/null)
n=$(echo "$files" | wc -l)

if ! command -v nixfmt &>/dev/null; then
  echo "nixfmt: not found, skipping"
  exit 2
fi

bad=$(echo "$files" | xargs nixfmt --check 2>&1 || true)
if [ -z "$bad" ]; then
  echo "nixfmt: $n files checked, all formatted"
else
  echo "$bad"
  count=$(echo "$bad" | grep -c 'not formatted' || true)
  echo "nixfmt: $count files need formatting"
  exit 1
fi
